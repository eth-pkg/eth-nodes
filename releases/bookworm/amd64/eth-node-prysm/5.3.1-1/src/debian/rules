#!/usr/bin/make -f
export GO_BIN_HOME=$(HOME)/go
export PATH:=$(PATH):$(GO_BIN_HOME)/bin
export CPPFLAGS:=$(shell dpkg-buildflags --get CPPFLAGS)
export CFLAGS:=$(shell dpkg-buildflags --get CFLAGS)
export CXXFLAGS:=$(shell dpkg-buildflags --get CXXFLAGS)
export LDFLAGS:=$(shell dpkg-buildflags --get LDFLAGS)
TARGETS = \
    //cmd/beacon-chain:beacon-chain \
    //cmd/prysmctl:prysmctl \
    //cmd/client-stats:client-stats \
    //cmd/validator:validator 

%:
	dh $@

override_dh_auto_test:
	echo "Runnint tests"
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //api/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //async/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //beacon-chain/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //build/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //cmd/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //config/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //consensus-types/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //container/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //contracts/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //crypto/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //encoding/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //io/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //math/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //monitoring/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //network/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //proto/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //runtime/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //testing/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //third_party/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //time/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //tools/...
    CGO_CFLAGS="-O2 -D__BLST_PORTABLE__" bazelisk test //validator/...

override_dh_auto_build:
	go install github.com/bazelbuild/bazelisk@v1.18.0
	chmod +x debian/hack/workspace_status.sh
	for target in ${TARGETS}; do \
		bazelisk build "$$target" --config=release; \
	done

override_dh_auto_install:

override_dh_auto_clean:
	# on ubuntu clean fails, before dependency installation
	# on bookworm clean succeeds, even if dependency is not installed
	-make -j1 clean

override_dh_dwz:
	# skip optimization of DWARF debug information in ELF binaries via dwz

override_dh_strip:
	dh_strip --no-automatic-dbgsym
